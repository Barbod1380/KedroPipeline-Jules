import os
import json
import pandas as pd
from ..load_rules import load_rules, process_phrases_to_dict_to_handle_underlines
from ..graph_model import SequenceTree

CONSTS_DIR = os.path.dirname(os.path.realpath(__file__))

VALID_REGIONS = pd.read_excel(
    os.path.join(CONSTS_DIR, "valid_regions.xlsx"),
    header=None,
).values.flatten()

POSTCODE_CORRECTION = pd.read_excel(
    os.path.join(CONSTS_DIR, "postcode_correction.xlsx"),
    header=None,
    names=["postcode", "region"],
    index_col="postcode",
)

SPECIAL_PLACES_DF = pd.read_excel(
    os.path.join(CONSTS_DIR, "special_places.xlsx"),
    header=None,
)
SPECIAL_PLACES = dict(zip(SPECIAL_PLACES_DF.iloc[:, 0], SPECIAL_PLACES_DF.iloc[:, 1]))

REGION_BASKET_MAP = {
    413: 293,
    414: 294,
    415: 295,
    416: 296,
    417: 297,
    418: 298,
    419: 299,
    410: -1,
    431: 251,
    441: 252,
}

GARBAGE_POSTCODES = (
    "1318711111",
    "1111111111",
    "1311111111",
    "1318915513",
    "1495613311",
    "1816145825",
    "1816145835",
    "1816145875",
)

SPECIAL_POSTCODES = {
    "416373874": 292,
    "416371119": 292,
    "416371178": 292,
    "416373181": 292,
    "416371212": 292,
    "416371766": 292,
    "416371888": 292,
    "416373896": 292,
    "416373556": 292,
    "416373554": 292,
    "416374174": 292,
    "416371517": 292,
    "416373313": 292,
    "416371853": 292,
    "416371941": 292,
    "416371919": 292,
    "416371745": 292,
    "416371987": 292,
    "416371664": 292,
    "416374411": 292,
    "416371593": 292,
    "416371897": 292,
    "416371161": 292,
    "416371597": 292,
    "416373494": 292,
    "416373167": 292,
    "416373699": 292,
    "416371945": 292,
    "416374139": 292,
    "416371563": 292,
    "416371444": 292,
    "416371873": 292,
    "416373754": 292,
    "416373154": 292,
    "416371575": 292,
    "416373716": 292,
    "416373381": 292,
    "416371566": 292,
    "416371599": 292,
    "416373819": 292,
    "416371719": 292,
    "416373654": 292,
    "416373314": 292,
    "416371683": 292,
    "416371949": 292,
    "416373414": 292,
    "416371754": 292,
    "416373869": 292,
    "416373693": 292,
    "416373779": 292,
    "416373148": 292,
    "416371346": 292,
    "416371338": 292,
    "416373855": 292,
    "416371654": 292,
    "416371445": 292,
    "416374147": 292,
    "416373137": 292,
    "416371953": 292,
    "416371899": 292,
    "416373696": 292,
    "416371155": 292,
    "416374391": 292,
    "416373479": 292,
    "416371783": 292,
    "416373617": 292,
    "416373816": 292,
    "416373886": 292,
    "416373719": 292,
    "416373917": 292,
    "416371547": 292,
    "416371937": 292,
    "416373687": 292,
    "416374333": 292,
    "416373197": 292,
    "416373533": 292,
    "416371464": 292,
    "416371313": 292,
    "416373555": 292,
    "416371734": 292,
    "416374115": 292,
    "416371896": 292,
    "416371455": 292,
    "416371433": 292,
    "416371571": 292,
    "416371898": 292,
    "416371884": 292,
    "416371193": 292,
    "416371518": 292,
    "416371185": 292,
    "416371466": 292,
    "416373144": 292,
    "416371656": 292,
    "416371778": 292,
    "416374187": 292,
    "416371934": 292,
    "416374355": 292,
    "416373163": 292,
    "416371468": 292,
    "416373333": 292,
    "416373553": 292,
    "416373116": 292,
    "416371875": 292,
    "416373784": 292,
    "416373464": 292,
    "416371618": 292,
    "416371439": 292,
    "416373636": 292,
    "416371114": 292,
    "416373573": 292,
    "416371737": 292,
    "416371585": 292,
    "416371496": 292,
    "416371394": 292,
    "416371118": 292,
    "416371469": 292,
    "416373166": 292,
    "416371154": 292,
    "416371331": 292,
    "416374158": 292,
    "416371451": 292,
    "416373751": 292,
    "416371633": 292,
    "416371677": 292,
    "416371768": 292,
    "416373988": 292,
    "416373771": 292,
    "416371914": 292,
    "416371841": 292,
    "416371438": 292,
    "416371477": 292,
    "416371988": 292,
    "416371871": 292,
    "416373189": 292,
    "416371314": 292,
    "416371159": 292,
    "416371844": 292,
    "416373756": 292,
    "416373986": 292,
    "416371479": 292,
    "416371981": 292,
    "416373643": 292,
    "416373657": 292,
    "416373581": 292,
    "416371954": 292,
    "416373334": 292,
    "416373438": 292,
    "416373338": 292,
    "416371364": 292,
    "416371413": 292,
    "416371719": 292,
    "416374315": 292,
    "416371315": 292,
}


PATTERN_PATH = os.path.join(CONSTS_DIR, "patterns.xlsx")
CORRECT_WORDS_SET = set(
    pd.read_excel(PATTERN_PATH, header=None)
    .iloc[:, 0]
    .str.split("[+_-]")
    .explode()
    .str.replace(".", "", regex=False)
    .to_list()
)
VALID_SPELL_CORRECTION_DICT = json.load(
    open(os.path.join(CONSTS_DIR, "spell_correction_dict.json"), encoding="utf-8")
)

RULES, df = load_rules(PATTERN_PATH)
REPLACEMENT_DICT = process_phrases_to_dict_to_handle_underlines(df)

ABBREVIATION_DICT = {
    " خ ": " خیابان ",
    " م ": " میدان ",
    " پ ": " پلاک",
    " ک ": " کوچه ",
}

KEYWORDS_TO_CUT_BEFORE = (
    " شهرستان ",
    " استان ",
    " روستا ",
    " منطقه ",
    " خیابان_رشت ",
    " نشانی ",
    " کیرنده ",
    " خریدار ",
    " ادرس ",
    " عدد_خیابان_تهران ",
)
KEYWORDS_TO_CUT_AFTER = (" طبقه ", " ساختمان ", " مجتمع ", " برج ", " پلاک ")

PREFIX_TO_REMOVE = (
    "کیلان",
    "مقصد",
    "کیانشهر",
    "رشت",
    "تهران",
    "عدد_خیابان_تهران",
    "خیابان_رشت",
    "بخش_مرکزی",
    "عدد",
    "شهر",
    "شهرستان",
    "استان",
    "روستا",
    "منطقه",
    "نشانی",
    "کیرنده",
    "خریدار",
    "ادرس",
    "کوفت",
    "اول",
)

graph_model = SequenceTree.load(os.path.join(CONSTS_DIR, "graph_rules.json"), "json")